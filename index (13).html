<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoCord - Encrypted Discord Clone</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/octokit/dist/octokit-bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .image-preview { max-width: 300px; max-height: 300px; border-radius: 8px; margin-top: 8px; border: 2px solid #4f46e5; }
        .msg-image { max-width: 100%; border-radius: 8px; margin-top: 8px; cursor: pointer; transition: transform 0.2s; }
        .msg-image:hover { transform: scale(1.02); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .message-input:focus { outline: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .typing-indicator { animation: pulse 1.5s infinite; }
        .online-pulse { animation: pulse 2s infinite; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen overflow-hidden">
    <!-- Auth Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-900 via-purple-900 to-gray-900">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="flex items-center justify-center space-x-2 mb-4">
                    <i class="fas fa-shield-alt text-4xl text-indigo-500"></i>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-500 bg-clip-text text-transparent">CryptoCord</h1>
                </div>
                <p class="text-gray-400">End-to-end encrypted chat with friends</p>
                <div class="mt-2 flex items-center justify-center space-x-2 text-green-400 text-sm">
                    <i class="fas fa-lock"></i>
                    <span>Powered by Gun.js + SEA Encryption</span>
                </div>
            </div>
            
            <div id="authTabs" class="flex mb-6">
                <button onclick="showAuthTab('login')" id="loginTab" class="flex-1 py-2 text-center border-b-2 border-indigo-500 text-indigo-400 font-semibold">Login</button>
                <button onclick="showAuthTab('register')" id="registerTab" class="flex-1 py-2 text-center border-b-2 border-gray-600 text-gray-400">Register</button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Username</label>
                        <input type="text" id="loginUsername" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter username">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Password</label>
                        <input type="password" id="loginPassword" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter password">
                    </div>
                    <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg font-semibold transition">Login</button>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Username</label>
                        <input type="text" id="regUsername" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Choose username">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Password</label>
                        <input type="password" id="regPassword" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Choose password (min 8 chars)">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Confirm Password</label>
                        <input type="password" id="regConfirm" class="w-full bg-gray-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Confirm password">
                    </div>
                    <button onclick="register()" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg font-semibold transition">Create Account</button>
                </div>
            </div>
            
            <p id="authError" class="text-red-400 text-center mt-4 hidden"></p>
            <p id="authSuccess" class="text-green-400 text-center mt-4 hidden"></p>
        </div>
        
        <!-- GitHub Sync Configuration -->
        <div id="githubConfig" class="fixed bottom-4 right-4 bg-gray-800 p-4 rounded-xl shadow-2xl border border-gray-700 w-80 text-sm z-50">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-bold flex items-center"><i class="fab fa-github mr-2"></i> GitHub DB Sync</h3>
                <button onclick="toggleGithubConfig()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="ghForm">
                <p class="text-xs text-gray-400 mb-3">Enter your GitHub Token to sync messages to <b>Mint1web/discord-clone-test</b>.</p>
                <input type="password" id="ghToken" placeholder="GitHub Personal Access Token" class="w-full bg-gray-900 rounded px-3 py-2 mb-2 outline-none border border-gray-600 focus:border-indigo-500">
                <input type="text" id="ghRepo" value="Mint1web/discord-clone-test" disabled class="w-full bg-gray-900 rounded px-3 py-2 mb-2 outline-none border border-gray-600 opacity-50 cursor-not-allowed">
                <button onclick="saveGithubConfig()" class="w-full bg-indigo-600 hover:bg-indigo-700 py-2 rounded font-bold transition">Enable GitHub Storage</button>
                <a href="https://github.com/settings/tokens" target="_blank" class="block text-center mt-2 text-indigo-400 text-xs hover:underline">Generate Token (repo scope)</a>
            </div>
            <div id="ghStatus" class="hidden">
                <div class="flex items-center text-green-400 mb-2">
                    <i class="fas fa-check-circle mr-2"></i> Connected to GitHub DB
                </div>
                <button onclick="disconnectGithub()" class="text-red-400 text-xs hover:underline">Disconnect</button>
            </div>
        </div>
        <button id="ghConfigBtn" onclick="toggleGithubConfig()" class="fixed bottom-4 right-4 bg-gray-800 p-3 rounded-full shadow-lg border border-gray-700 hidden">
            <i class="fab fa-github text-xl"></i>
        </button>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden h-screen flex">
        <!-- Server List -->
        <div class="w-18 bg-gray-900 flex flex-col items-center py-3 space-y-2">
            <button onclick="showDirectMessages()" class="w-12 h-12 bg-gray-700 hover:bg-indigo-600 rounded-2xl hover:rounded-xl transition-all flex items-center justify-center group" title="Direct Messages">
                <i class="fas fa-comments text-xl text-gray-300 group-hover:text-white"></i>
            </button>
            <div class="w-8 h-0.5 bg-gray-700 rounded-full"></div>
            
            <div id="serverList" class="flex flex-col items-center space-y-2 overflow-y-auto hide-scrollbar flex-1">
                <!-- Servers will be rendered here -->
            </div>
            
            <button onclick="showCreateServer()" class="w-12 h-12 bg-gray-700 hover:bg-green-600 rounded-2xl hover:rounded-xl transition-all flex items-center justify-center group" title="Add Server">
                <i class="fas fa-plus text-xl text-green-500 group-hover:text-white"></i>
            </button>
            <button onclick="showJoinServer()" class="w-12 h-12 bg-gray-700 hover:bg-green-600 rounded-2xl hover:rounded-xl transition-all flex items-center justify-center group" title="Join Server">
                <i class="fas fa-compass text-xl text-green-500 group-hover:text-white"></i>
            </button>
        </div>

        <!-- Channel List -->
        <div class="w-60 bg-gray-800 flex flex-col">
            <div id="serverHeader" class="h-12 px-4 flex items-center justify-between border-b border-gray-900 shadow-md">
                <h2 id="serverName" class="font-bold truncate">Direct Messages</h2>
                <button onclick="showServerSettings()" class="text-gray-400 hover:text-white"><i class="fas fa-chevron-down"></i></button>
            </div>
            
            <div id="channelList" class="flex-1 overflow-y-auto hide-scrollbar p-2">
                <!-- Channels rendered here -->
            </div>
            
            <!-- User Panel -->
            <div class="h-14 bg-gray-850 bg-opacity-50 px-2 flex items-center justify-between border-t border-gray-900" style="background-color: #292b2f;">
                <div class="flex items-center space-x-2">
                    <div class="relative">
                        <div id="userAvatar" class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-sm font-bold"></div>
                        <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-gray-800"></div>
                    </div>
                    <div class="leading-tight">
                        <p id="displayUsername" class="text-sm font-semibold"></p>
                        <p class="text-xs text-gray-400">#<span id="displayTag">0000</span></p>
                    </div>
                </div>
                <div class="flex space-x-1">
                    <button class="p-2 hover:bg-gray-700 rounded" title="Mute"><i class="fas fa-microphone text-gray-400 text-sm"></i></button>
                    <button class="p-2 hover:bg-gray-700 rounded" title="Deafen"><i class="fas fa-headphones text-gray-400 text-sm"></i></button>
                    <button onclick="logout()" class="p-2 hover:bg-gray-700 rounded" title="Logout"><i class="fas fa-sign-out-alt text-gray-400 text-sm"></i></button>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col bg-gray-700">
            <!-- Channel Header -->
            <div class="h-12 px-4 flex items-center justify-between border-b border-gray-900 shadow-sm">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-hashtag text-gray-400"></i>
                    <span id="channelName" class="font-bold">general</span>
                    <span class="text-gray-400 text-sm ml-2" id="channelDesc"></span>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-400 hover:text-white"><i class="fas fa-bell"></i></button>
                    <button class="text-gray-400 hover:text-white"><i class="fas fa-thumbtack"></i></button>
                    <button onclick="toggleMemberList()" class="text-gray-400 hover:text-white"><i class="fas fa-users"></i></button>
                    <div class="relative">
                        <input type="text" placeholder="Search" class="bg-gray-900 text-sm rounded px-2 py-1 w-36 focus:w-48 transition-all outline-none">
                        <i class="fas fa-search absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                    </div>
                </div>
            </div>

            <div class="flex flex-1 overflow-hidden">
                <!-- Messages Area -->
                <div class="flex-1 flex flex-col">
                    <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar">
                        <!-- Messages will be rendered here -->
                        <div id="welcomeMessage" class="text-center py-20">
                            <div class="w-20 h-20 bg-gray-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                                <i class="fas fa-hashtag text-4xl text-gray-400"></i>
                            </div>
                            <h2 class="text-2xl font-bold mb-2">Welcome to #<span id="welcomeChannel">general</span>!</h2>
                            <p class="text-gray-400">This is the start of the channel. Messages are end-to-end encrypted.</p>
                        </div>
                    </div>
                    
                    <!-- Typing Indicator -->
                    <div id="typingIndicator" class="px-4 h-6 text-sm text-gray-400 hidden">
                        <span class="typing-indicator"><span id="typingUsers"></span> is typing...</span>
                    </div>

                    <!-- Message Input -->
                    <div class="p-4 pt-0">
                        <div id="imagePreviewContainer" class="hidden mb-2 p-2 bg-gray-800 rounded-lg relative inline-block">
                            <img id="imagePreview" src="" class="image-preview">
                            <button onclick="clearImagePreview()" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center -mt-2 -mr-2 shadow-lg hover:bg-red-600">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                        </div>
                        <div class="bg-gray-600 rounded-lg flex items-center px-4">
                            <input type="file" id="imageInput" class="hidden" accept="image/*" onchange="previewImage(this)">
                            <button onclick="document.getElementById('imageInput').click()" class="text-gray-400 hover:text-white p-2" title="Upload Image"><i class="fas fa-plus-circle text-xl"></i></button>
                            <input type="text" id="messageInput" class="flex-1 bg-transparent py-3 px-2 message-input" placeholder="Message #general" onkeypress="handleTyping(event)">
                            <div class="flex items-center space-x-2">
                                <button class="text-gray-400 hover:text-white p-2" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 flex items-center"><i class="fas fa-lock mr-1"></i> End-to-end encrypted • Max 1MB images</p>
                    </div>
                </div>

                <!-- Member List -->
                <div id="memberList" class="w-60 bg-gray-800 p-4 overflow-y-auto hide-scrollbar">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase mb-2">Online — <span id="onlineCount">0</span></h3>
                    <div id="onlineMembers" class="space-y-1 mb-4">
                        <!-- Online members -->
                    </div>
                    <h3 class="text-xs font-semibold text-gray-400 uppercase mb-2">Offline — <span id="offlineCount">0</span></h3>
                    <div id="offlineMembers" class="space-y-1">
                        <!-- Offline members -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Server Modal -->
    <div id="createServerModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-2">Create Your Server</h2>
            <p class="text-gray-400 text-center mb-6">Give your server a name. You can always change it later.</p>
            <input type="text" id="newServerName" placeholder="Server Name" class="w-full bg-gray-700 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <div class="flex space-x-3">
                <button onclick="hideModals()" class="flex-1 py-3 rounded-lg bg-gray-600 hover:bg-gray-500 transition">Cancel</button>
                <button onclick="createServer()" class="flex-1 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition font-semibold">Create</button>
            </div>
            <p class="text-center text-sm text-gray-400 mt-4">Share the Server ID with friends to invite them!</p>
        </div>
    </div>

    <!-- Join Server Modal -->
    <div id="joinServerModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-2">Join a Server</h2>
            <p class="text-gray-400 text-center mb-6">Enter the Server ID to join your friends!</p>
            <input type="text" id="joinServerId" placeholder="Server ID" class="w-full bg-gray-700 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-indigo-500 outline-none">
            <div class="flex space-x-3">
                <button onclick="hideModals()" class="flex-1 py-3 rounded-lg bg-gray-600 hover:bg-gray-500 transition">Cancel</button>
                <button onclick="joinServer()" class="flex-1 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition font-semibold">Join</button>
            </div>
        </div>
    </div>

    <!-- Server Settings Modal -->
    <div id="serverSettingsModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-4">Server Settings</h2>
            <div class="bg-gray-700 rounded-lg p-4 mb-4">
                <p class="text-sm text-gray-400 mb-1">Server ID (Share with friends)</p>
                <div class="flex items-center space-x-2">
                    <code id="serverIdDisplay" class="flex-1 bg-gray-900 px-3 py-2 rounded text-green-400 text-sm"></code>
                    <button onclick="copyServerId()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded transition"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Create New Channel</label>
                <div class="flex space-x-2">
                    <input type="text" id="newChannelName" placeholder="channel-name" class="flex-1 bg-gray-700 rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                    <button onclick="createChannel()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <button onclick="hideModals()" class="w-full py-3 rounded-lg bg-gray-600 hover:bg-gray-500 transition">Close</button>
        </div>
    </div>

    <script>
        // Initialize Gun with public relay peers
        const gun = Gun({
            peers: [
                'https://gun-manhattan.herokuapp.com/gun',
                'https://gun-us.herokuapp.com/gun',
                'https://gun-eu.herokuapp.com/gun'
            ],
            localStorage: true
        });
        
        const user = gun.user().recall({ sessionStorage: true });
        const SEA = Gun.SEA;
        
        // App State
        let currentUser = null;
        let currentServer = null;
        let currentChannel = null;
        let servers = {};
        let messageListeners = {};
        let typingTimeout = null;
        let pendingImageBase64 = null;
        
        // GitHub Database State
        let ghClient = null;
        // Hardcoding the target repo as requested
        let ghConfig = { token: '', repo: 'Mint1web/discord-clone-test' };

        // GitHub DB Logic
        function toggleGithubConfig() {
            const config = document.getElementById('githubConfig');
            const btn = document.getElementById('ghConfigBtn');
            config.classList.toggle('hidden');
            btn.classList.toggle('hidden');
        }

        async function saveGithubConfig() {
            const token = document.getElementById('ghToken').value.trim();
            const repo = 'Mint1web/discord-clone-test';
            
            if (!token) {
                alert("Please provide a GitHub Token.");
                return;
            }

            try {
                const octokit = new Octokit({ auth: token });
                const [owner, name] = repo.split('/');
                await octokit.rest.repos.get({ owner, repo: name });
                
                ghConfig = { token, repo };
                localStorage.setItem('cc_gh_config', JSON.stringify(ghConfig));
                ghClient = octokit;
                
                document.getElementById('ghForm').classList.add('hidden');
                document.getElementById('ghStatus').classList.remove('hidden');
                alert("GitHub Database Connected! Now storing to Mint1web/discord-clone-test");
            } catch (e) {
                alert("Error connecting to GitHub. Check your token and ensure you have access to Mint1web/discord-clone-test: " + e.message);
            }
        }

        function loadGithubConfig() {
            const saved = localStorage.getItem('cc_gh_config');
            if (saved) {
                ghConfig = JSON.parse(saved);
                document.getElementById('ghToken').value = ghConfig.token;
                document.getElementById('ghRepo').value = ghConfig.repo;
                ghClient = new Octokit({ auth: ghConfig.token });
                document.getElementById('ghForm').classList.add('hidden');
                document.getElementById('ghStatus').classList.remove('hidden');
                document.getElementById('githubConfig').classList.add('hidden');
                document.getElementById('ghConfigBtn').classList.remove('hidden');
            }
        }

        function disconnectGithub() {
            localStorage.removeItem('cc_gh_config');
            ghClient = null;
            document.getElementById('ghForm').classList.remove('hidden');
            document.getElementById('ghStatus').classList.add('hidden');
        }

        async function syncToGithub(path, content) {
            if (!ghClient) return;
            const [owner, repo] = ghConfig.repo.split('/');
            const filePath = `db/${path}.json`;
            
            try {
                let sha;
                try {
                    const { data } = await ghClient.rest.repos.getContent({ owner, repo, path: filePath });
                    sha = data.sha;
                } catch (e) {}

                await ghClient.rest.repos.createOrUpdateFileContents({
                    owner, repo, path: filePath,
                    message: `Update ${path}`,
                    content: btoa(JSON.stringify(content)),
                    sha: sha
                });
            } catch (e) {
                console.error("GitHub Sync Error:", e);
            }
        }

        // Auth Functions
        function showAuthTab(tab) {
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
            document.getElementById('loginTab').classList.toggle('border-indigo-500', tab === 'login');
            document.getElementById('loginTab').classList.toggle('text-indigo-400', tab === 'login');
            document.getElementById('loginTab').classList.toggle('border-gray-600', tab !== 'login');
            document.getElementById('loginTab').classList.toggle('text-gray-400', tab !== 'login');
            document.getElementById('registerTab').classList.toggle('border-indigo-500', tab === 'register');
            document.getElementById('registerTab').classList.toggle('text-indigo-400', tab === 'register');
            document.getElementById('registerTab').classList.toggle('border-gray-600', tab !== 'register');
            document.getElementById('registerTab').classList.toggle('text-gray-400', tab !== 'register');
            hideAuthMessages();
        }

        function showError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function showSuccess(msg) {
            const el = document.getElementById('authSuccess');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function hideAuthMessages() {
            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authSuccess').classList.add('hidden');
        }

        async function register() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirm').value;
            
            hideAuthMessages();
            
            if (!username || !password) {
                showError('Please fill in all fields');
                return;
            }
            if (password.length < 8) {
                showError('Password must be at least 8 characters');
                return;
            }
            if (password !== confirm) {
                showError('Passwords do not match');
                return;
            }
            
            user.create(username, password, (ack) => {
                if (ack.err) {
                    showError(ack.err);
                } else {
                    showSuccess('Account created! You can now login.');
                    const tag = Math.floor(1000 + Math.random() * 9000);
                    gun.get('users').get(username).put({ 
                        username: username, 
                        tag: tag,
                        createdAt: Date.now()
                    });
                    showAuthTab('login');
                }
            });
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            hideAuthMessages();
            
            if (!username || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            user.auth(username, password, (ack) => {
                if (ack.err) {
                    showError('Invalid username or password');
                } else {
                    currentUser = {
                        username: username,
                        pub: user.is.pub
                    };
                    
                    gun.get('users').get(username).once((data) => {
                        if (data && data.tag) {
                            currentUser.tag = data.tag;
                        } else {
                            currentUser.tag = Math.floor(1000 + Math.random() * 9000);
                        }
                        initApp();
                    });
                }
            });
        }

        function logout() {
            user.leave();
            currentUser = null;
            currentServer = null;
            currentChannel = null;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Initialize App
        function initApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('displayUsername').textContent = currentUser.username;
            document.getElementById('displayTag').textContent = currentUser.tag;
            document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
            
            // Set online presence
            gun.get('presence').get(currentUser.username).put({
                online: true,
                lastSeen: Date.now()
            });
            
            // Update presence on window close
            window.addEventListener('beforeunload', () => {
                gun.get('presence').get(currentUser.username).put({
                    online: false,
                    lastSeen: Date.now()
                });
            });
            
            loadUserServers();
        }

        // Server Functions
        function loadUserServers() {
            gun.get('userServers').get(currentUser.username).map().once((serverId, key) => {
                if (serverId && typeof serverId === 'string') {
                    loadServer(serverId);
                }
            });
            showDirectMessages();
        }

        function loadServer(serverId) {
            gun.get('servers').get(serverId).once((serverData) => {
                if (serverData && serverData.name) {
                    servers[serverId] = serverData;
                    renderServerList();
                }
            });
        }

        function renderServerList() {
            const container = document.getElementById('serverList');
            container.innerHTML = '';
            
            Object.keys(servers).forEach(serverId => {
                const server = servers[serverId];
                const btn = document.createElement('button');
                btn.className = 'w-12 h-12 bg-gray-700 hover:bg-indigo-600 rounded-2xl hover:rounded-xl transition-all flex items-center justify-center group relative';
                btn.title = server.name;
                btn.innerHTML = `<span class="font-bold text-lg">${server.name.charAt(0).toUpperCase()}</span>`;
                btn.onclick = () => selectServer(serverId);
                
                if (currentServer === serverId) {
                    btn.classList.remove('bg-gray-700', 'rounded-2xl');
                    btn.classList.add('bg-indigo-600', 'rounded-xl');
                }
                
                container.appendChild(btn);
            });
        }

        function selectServer(serverId) {
            currentServer = serverId;
            const server = servers[serverId];
            document.getElementById('serverName').textContent = server.name;
            renderServerList();
            loadChannels(serverId);
        }

        function showDirectMessages() {
            currentServer = null;
            currentChannel = null;
            document.getElementById('serverName').textContent = 'Direct Messages';
            document.getElementById('channelList').innerHTML = `
                <p class="text-xs text-gray-400 uppercase font-semibold px-2 mb-2">Direct Messages</p>
                <p class="text-gray-500 text-sm px-2">DMs coming soon...</p>
                <p class="text-xs text-gray-600 px-2 mt-4">Join or create a server to start chatting!</p>
            `;
            document.getElementById('messagesContainer').innerHTML = `
                <div class="text-center py-20">
                    <i class="fas fa-comments text-6xl text-gray-600 mb-4"></i>
                    <h2 class="text-xl font-bold mb-2">Welcome to CryptoCord!</h2>
                    <p class="text-gray-400">Create or join a server to start chatting with friends.</p>
                </div>
            `;
            renderServerList();
        }

        function loadChannels(serverId) {
            const container = document.getElementById('channelList');
            container.innerHTML = '<p class="text-xs text-gray-400 uppercase font-semibold px-2 mb-2">Text Channels</p>';
            
            gun.get('serverChannels').get(serverId).map().once((channelData, channelId) => {
                if (channelData && channelData.name) {
                    const btn = document.createElement('button');
                    btn.className = 'w-full flex items-center space-x-2 px-2 py-1.5 rounded hover:bg-gray-700 text-gray-400 hover:text-white transition';
                    btn.innerHTML = `<i class="fas fa-hashtag text-sm"></i><span>${channelData.name}</span>`;
                    btn.onclick = () => selectChannel(serverId, channelId, channelData.name);
                    container.appendChild(btn);
                    
                    // Auto-select first channel
                    if (!currentChannel) {
                        selectChannel(serverId, channelId, channelData.name);
                    }
                }
            });
        }

        async function selectChannel(serverId, channelId, channelName) {
            currentChannel = { serverId, channelId, name: channelName };
            document.getElementById('channelName').textContent = channelName;
            document.getElementById('welcomeChannel').textContent = channelName;
            document.getElementById('messageInput').placeholder = `Message #${channelName}`;
            
            // Clear previous messages
            document.getElementById('messagesContainer').innerHTML = `
                <div id="welcomeMessage" class="text-center py-10">
                    <div class="w-16 h-16 bg-gray-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-hashtag text-3xl text-gray-400"></i>
                    </div>
                    <h2 class="text-xl font-bold mb-2">Welcome to #${channelName}!</h2>
                    <p class="text-gray-400 text-sm">This is the start of the channel. Messages are end-to-end encrypted.</p>
                </div>
            `;
            
            loadMessages();
            loadMembers();
        }

        async function loadMessages() {
            if (!currentChannel) return;
            
            const messagesRef = gun.get('messages').get(currentChannel.serverId).get(currentChannel.channelId);
            
            // Listen for new messages
            messagesRef.map().on(async (encryptedData, msgId) => {
                if (!encryptedData || encryptedData === null) return;
                
                try {
                    // For simplicity, we're using a shared server key based on server ID
                    // In production, you'd use proper key exchange
                    const serverKey = currentChannel.serverId.slice(0, 32);
                    
                    let msgData;
                    if (typeof encryptedData === 'string') {
                        msgData = JSON.parse(encryptedData);
                    } else {
                        msgData = encryptedData;
                    }
                    
                    if (msgData && msgData.content && msgData.username) {
                        renderMessage(msgId, msgData);
                    }
                } catch (e) {
                    console.log('Message parse error:', e);
                }
            });
        }

        function renderMessage(msgId, msgData) {
            const container = document.getElementById('messagesContainer');
            
            // Hide welcome message
            const welcome = document.getElementById('welcomeMessage');
            if (welcome) welcome.style.display = 'none';
            
            // Check if message already exists
            if (document.getElementById(`msg-${msgId}`)) return;
            
            const msgEl = document.createElement('div');
            msgEl.id = `msg-${msgId}`;
            msgEl.className = 'flex items-start space-x-4 hover:bg-gray-750 p-2 rounded group';
            msgEl.style.backgroundColor = 'transparent';
            msgEl.onmouseenter = () => msgEl.style.backgroundColor = 'rgba(0,0,0,0.1)';
            msgEl.onmouseleave = () => msgEl.style.backgroundColor = 'transparent';
            
            const time = new Date(msgData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const initial = msgData.username.charAt(0).toUpperCase();
            const color = getAvatarColor(msgData.username);
            
            let contentHtml = `<p class="text-gray-200 break-words">${escapeHtml(msgData.content)}</p>`;
            if (msgData.image) {
                contentHtml += `<img src="${msgData.image}" class="msg-image" onclick="window.open(this.src)" title="Click to enlarge">`;
            }

            msgEl.innerHTML = `
                <div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold" style="background-color: ${color}">
                    ${initial}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-baseline space-x-2">
                        <span class="font-semibold hover:underline cursor-pointer">${msgData.username}</span>
                        <span class="text-xs text-gray-400">${time}</span>
                    </div>
                    ${contentHtml}
                </div>
            `;
            
            container.appendChild(msgEl);
            container.scrollTop = container.scrollHeight;
        }

        function previewImage(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 1024 * 1024) {
                    alert("Image too large! Please keep it under 1MB for P2P performance.");
                    input.value = "";
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    pendingImageBase64 = e.target.result;
                    document.getElementById('imagePreview').src = pendingImageBase64;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImagePreview() {
            pendingImageBase64 = null;
            document.getElementById('imagePreviewContainer').classList.add('hidden');
            document.getElementById('imageInput').value = "";
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if ((!content && !pendingImageBase64) || !currentChannel) return;
            
            const msgData = {
                content: content,
                username: currentUser.username,
                timestamp: Date.now(),
                image: pendingImageBase64
            };
            
            const msgId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            // Put to P2P Gun DB
            gun.get('messages')
                .get(currentChannel.serverId)
                .get(currentChannel.channelId)
                .get(msgId)
                .put(JSON.stringify(msgData));
            
            // Backup to GitHub DB if configured
            if (ghClient) {
                syncToGithub(`messages/${currentChannel.serverId}/${currentChannel.channelId}/${msgId}`, msgData);
            }
            
            input.value = '';
            clearImagePreview();
        }

        function handleTyping(event) {
            if (event.key === 'Enter') {
                sendMessage();
                return;
            }
            
            // Typing indicator
            if (currentChannel) {
                gun.get('typing')
                    .get(currentChannel.serverId)
                    .get(currentChannel.channelId)
                    .get(currentUser.username)
                    .put(Date.now());
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    gun.get('typing')
                        .get(currentChannel.serverId)
                        .get(currentChannel.channelId)
                        .get(currentUser.username)
                        .put(null);
                }, 3000);
            }
        }

        function loadMembers() {
            if (!currentServer) return;
            
            const onlineContainer = document.getElementById('onlineMembers');
            const offlineContainer = document.getElementById('offlineMembers');
            let onlineCount = 0;
            let offlineCount = 0;
            
            onlineContainer.innerHTML = '';
            offlineContainer.innerHTML = '';
            
            gun.get('serverMembers').get(currentServer).map().once((memberData, username) => {
                if (!memberData || !username) return;
                
                gun.get('presence').get(username).once((presence) => {
                    const isOnline = presence && presence.online && (Date.now() - presence.lastSeen < 30000);
                    const container = isOnline ? onlineContainer : offlineContainer;
                    
                    if (isOnline) onlineCount++;
                    else offlineCount++;
                    
                    const memberEl = document.createElement('div');
                    memberEl.className = 'flex items-center space-x-2 p-2 rounded hover:bg-gray-700 cursor-pointer';
                    
                    const color = getAvatarColor(username);
                    memberEl.innerHTML = `
                        <div class="relative">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold" style="background-color: ${color}">
                                ${username.charAt(0).toUpperCase()}
                            </div>
                            <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 ${isOnline ? 'bg-green-500' : 'bg-gray-500'} rounded-full border-2 border-gray-800"></div>
                        </div>
                        <span class="${isOnline ? 'text-white' : 'text-gray-400'}">${username}</span>
                    `;
                    
                    container.appendChild(memberEl);
                    
                    document.getElementById('onlineCount').textContent = onlineCount;
                    document.getElementById('offlineCount').textContent = offlineCount;
                });
            });
        }

        // Server Creation/Joining
        function showCreateServer() {
            document.getElementById('createServerModal').classList.remove('hidden');
            document.getElementById('createServerModal').classList.add('flex');
        }

        function showJoinServer() {
            document.getElementById('joinServerModal').classList.remove('hidden');
            document.getElementById('joinServerModal').classList.add('flex');
        }

        function showServerSettings() {
            if (!currentServer) return;
            document.getElementById('serverIdDisplay').textContent = currentServer;
            document.getElementById('serverSettingsModal').classList.remove('hidden');
            document.getElementById('serverSettingsModal').classList.add('flex');
        }

        function hideModals() {
            document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
        }

        async function createServer() {
            const name = document.getElementById('newServerName').value.trim();
            if (!name) return;
            
            const serverId = 'srv-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const serverData = {
                name: name,
                owner: currentUser.username,
                createdAt: Date.now()
            };
            
            gun.get('servers').get(serverId).put(serverData);
            gun.get('userServers').get(currentUser.username).get(serverId).put(serverId);
            gun.get('serverMembers').get(serverId).get(currentUser.username).put({ joinedAt: Date.now() });
            
            // Create default channel
            const channelId = 'ch-general';
            gun.get('serverChannels').get(serverId).get(channelId).put({ name: 'general', createdAt: Date.now() });
            
            servers[serverId] = serverData;
            renderServerList();
            selectServer(serverId);
            
            document.getElementById('newServerName').value = '';
            hideModals();
            
            // Show server ID
            setTimeout(() => {
                alert(`Server created! Share this ID with friends:\n\n${serverId}`);
            }, 500);
        }

        async function joinServer() {
            const serverId = document.getElementById('joinServerId').value.trim();
            if (!serverId) return;
            
            gun.get('servers').get(serverId).once((serverData) => {
                if (serverData && serverData.name) {
                    gun.get('userServers').get(currentUser.username).get(serverId).put(serverId);
                    gun.get('serverMembers').get(serverId).get(currentUser.username).put({ joinedAt: Date.now() });
                    
                    servers[serverId] = serverData;
                    renderServerList();
                    selectServer(serverId);
                    
                    document.getElementById('joinServerId').value = '';
                    hideModals();
                } else {
                    alert('Server not found! Please check the ID.');
                }
            });
        }

        function createChannel() {
            if (!currentServer) return;
            
            let name = document.getElementById('newChannelName').value.trim().toLowerCase().replace(/\s+/g, '-');
            if (!name) return;
            
            const channelId = 'ch-' + Date.now();
            gun.get('serverChannels').get(currentServer).get(channelId).put({ name: name, createdAt: Date.now() });
            
            document.getElementById('newChannelName').value = '';
            loadChannels(currentServer);
        }

        function copyServerId() {
            navigator.clipboard.writeText(currentServer);
            const btn = event.target.closest('button');
            btn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i>', 2000);
        }

        function toggleMemberList() {
            document.getElementById('memberList').classList.toggle('hidden');
        }

        // Utility Functions
        function getAvatarColor(username) {
            const colors = ['#5865F2', '#57F287', '#FEE75C', '#EB459E', '#ED4245', '#9B59B6', '#3498DB', '#1ABC9C', '#E67E22', '#E74C3C'];
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check for existing session
        user.recall({ sessionStorage: true }, () => {
            loadGithubConfig();
            if (user.is) {
                currentUser = {
                    username: user.is.alias,
                    pub: user.is.pub
                };
                gun.get('users').get(user.is.alias).once((data) => {
                    currentUser.tag = data?.tag || Math.floor(1000 + Math.random() * 9000);
                    initApp();
                });
            }
        });

        // Presence heartbeat
        setInterval(() => {
            if (currentUser) {
                gun.get('presence').get(currentUser.username).put({
                    online: true,
                    lastSeen: Date.now()
                });
                if (currentServer) loadMembers();
            }
        }, 15000);

        // Listen for typing indicators
        setInterval(() => {
            if (!currentChannel) return;
            
            gun.get('typing')
                .get(currentChannel.serverId)
                .get(currentChannel.channelId)
                .map()
                .once((timestamp, username) => {
                    if (timestamp && username !== currentUser.username && Date.now() - timestamp < 3000) {
                        document.getElementById('typingIndicator').classList.remove('hidden');
                        document.getElementById('typingUsers').textContent = username;
                    } else {
                        document.getElementById('typingIndicator').classList.add('hidden');
                    }
                });
        }, 1000);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') hideModals();
        });
    </script>
</body>
</html>
